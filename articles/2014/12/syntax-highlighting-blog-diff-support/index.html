<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><title data-react-helmet="true">Syntax Highlighted Diffs For Everyone • Blake Embrey</title><meta data-react-helmet="true" name="description" content="A personally curated collection of words hosted in cyberspace for an indeterminate duration."/><style data-react-free-style="true">::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-cancel-button,[type="search"]::-webkit-search-decoration{-webkit-appearance:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}audio:not([controls]){display:none;height:0}b,strong{font-weight:inherit;font-weight:bolder}button,html [type="button"], [type="reset"],[type="submit"]{-webkit-appearance:button}button,input{overflow:visible}button,input,optgroup,select,textarea{margin:0}button,select{text-transform:none}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}audio,video,canvas{display:inline-block}dfn{font-style:italic}article,aside,footer,header,nav,section,details,menu,figcaption,figure,main{display:block}figure{margin:1em 40px}h1{font-size:2em;margin:0.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.15}img{border-style:none}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}mark{background-color:#ff0;color:#000}code,kbd,samp,pre{font-family:monospace, monospace;font-size:1em}progress{display:inline-block;vertical-align:baseline}small{font-size:80%}sub{bottom:-0.25em}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}summary{display:list-item}sup{top:-0.5em}svg:not(:root){overflow:hidden}[hidden],template{display:none}textarea{overflow:auto}*{box-sizing:border-box}.hljs-addition{background:#dfd}.hljs-attribute,.hljs-variable,.hljs-body{color:#008080}.hljs-change{background:#0086b3}.hljs-class .hljs-title,.hljs-type,.hljs-literal,.hljs-command{color:#458;font-weight:500}.hljs-deletion{background:#fdd}.hljs-header,.hljs-comment,.hljs-javadoc{color:#969896}.hljs-keyword,.hljs-winutils,.hljs-subst,.hljs-request,.hljs-status{color:#a71d5d}.hljs-built_in,.hljs-number,.hljs-hexcolor,.hljs-constant{color:#0086b3}.hljs-preprocessor,.hljs-pragma,.hljs-pi,.hljs-doctype,.hljs-shebang,.hljs-cdata{color:#999;font-weight:500}.hljs-regexp{color:#009926}.hljs-string,.hljs-tag .hljs-value,.hljs-phpdoc,.hljs-dartdoc,.hljs-formula{color:#df5000}.hljs-symbol,.hljs-symbol .hljs-string,.hljs-special,.hljs-prompt{color:#990073}.hljs-tag,.hljs-tag .hljs-title,.hljs-rules .hljs-property{color:#000080}.hljs-title,.hljs-id,.hljs-preprocessor{color:#795da3}a{border-bottom:2px solid #dcdcdc;color:#111;text-decoration:none}a:hover{border-bottom-color:#f20}body{color:#111;font-family:sans-serif;font-size:17px;font-weight:300;line-height:1.7;margin:0}pre .diff-addition{background-color:#dfd}.hljs-chunk,pre .diff-chunk{color:#aaa}pre .diff-deletion{background-color:#fdd}.f1evzss3{border-top:4px solid #f20}.fsclf6o{margin:0 auto;max-width:640px;padding:20px}.f5tm013{margin:0;padding:30px 0}.f5tm013 > li{display:inline-block;list-style:none;margin-right:20px}.f5qoj4b{border-bottom-color:transparent;color:#333}.f13o7dmr h1, h2, h3, h4, h5, h6{font-weight:500}.f13o7dmr h1{font-size:1.7em}.f13o7dmr h2{font-size:1.3em}.f13o7dmr h3{font-size:1.1em}.f13o7dmr hr{border-bottom:1px dashed #fff;border-top:1px dashed #aaa;display:block;margin:1.5em 0}.f13o7dmr blockquote{border-left:4px solid #f20;margin:1em 0;padding-left:1em}.f13o7dmr img,audio,embed,video,object{height:auto;max-width:100%}.f13o7dmr code, pre{background-color:#f3f3f3;border:1px solid #ccc;color:#111;font-family:monospace;font-size:0.9em}.f13o7dmr pre{line-height:1.3;overflow-x:auto;padding:0.6em 0.8em}.f13o7dmr code{border-color:#ccc;display:inline;padding:0 0.3em;white-space:pre-line;word-wrap:break-word}.f13o7dmr pre > code{background-color:transparent;border:none;font-size:100%;padding:0;white-space:pre;word-wrap:normal}.f13o7dmr a:hover > code{border-color:#f20}.f1ymzfbz{color:#777;font-size:0.85em;margin:1.5em 0;padding:0}.f1ymzfbz > li > a{color:#777}.f1ymzfbz > li{display:inline-block;list-style:none;padding-right:20px}</style></head><body><div id="react-mount"><div data-reactroot="" data-reactid="1" data-react-checksum="1710101760"><!-- react-empty: 2 --><div class="f1evzss3" data-reactid="3"></div><div class="fsclf6o" data-reactid="4"><ul class="f5tm013" data-reactid="5"><li data-reactid="6"><a class="f5qoj4b" href="/" data-reactid="7">Blog</a></li><li data-reactid="8"><a class="f5qoj4b" href="http://blakeembrey.me" data-reactid="9">About</a></li><li data-reactid="10"><a class="f5qoj4b" href="/rss.xml" data-reactid="11">RSS</a></li></ul><div class="f13o7dmr" data-reactid="12"><div data-reactid="13"><!-- react-empty: 14 --><h1 data-reactid="15">Syntax Highlighted Diffs For Everyone</h1><ul class="f1ymzfbz" data-reactid="16"><li data-reactid="17"><!-- react-text: 18 -->Written<!-- /react-text --><!-- react-text: 19 --> <!-- /react-text --><time datetime="2014-12-26T08:30:00.000Z" data-reactid="20">December 2014</time></li><li data-reactid="21"><a href="https://github.com/blakeembrey/highlighter" data-reactid="22">View on GitHub</a></li><li data-reactid="23"><a href="http://npmjs.org/package/highlighter" data-reactid="24">Install with NPM</a></li></ul><div data-reactid="25"><p>This is a recount, of sorts, on how I added syntax highlighting to diffs on my blog and turned it into a module for anyone to use. The module is made for syntax highlighting Markdown files straight out of the box (supporting <a href="https://github.com/chjj/marked">marked</a> style highlight callbacks). Check out GitHub and npm for the final result.</p>
<p>Two weeks ago, <a href="https://github.com/blog/1932-syntax-highlighted-diffs">GitHub announced</a> a new feature - syntax highlighting of diffs. A couple of months earlier, I wrote a detailed <a href="/articles/2014/09/building-a-blog-with-metalsmith/">introduction to Metalsmith</a> where I used diffs to show the readers what changed at each step. Before I published it I discovered that the diff highlighting by <a href="https://highlightjs.org/">Highlight.js</a> left the addition and deletion marks inline, which degraded the reading experience. Determined to push live, I forged through and <a href="https://github.com/blakeembrey/blakeembrey.com/commit/206bbb0e047bfe24f92d25d847986ebed6548e06#diff-15ac5cd3ab657e091ee4aa5456e97ddeR68">manually highlighted each line</a> myself.</p>
<p>Fixing that monstrosity sat on my backlog for months. Finally, I gathered enough time and mental bandwidth to go back and figure out a better solution. It took three complete rewrites over the course of a conference (and then some) to come up with the current solution. This article is more about the thought process over the week than it is about implementing this yourself. That part should be easy for you, just install from npm.</p>
<h2>First Attempt</h2>
<p>The first attempt was simple. I googled around and discovered very little information on the topic, so I implemented the only way I saw mentioned. I syntax highlighted the code first, then I run over the generated markup and matched for diff-like syntax (<a href="https://github.com/blakeembrey/blakeembrey.com/blob/dfcedefc853cc01ba33539c9b9b2576b1c23aceb/config/markdown.js">code here</a>) and wrap those lines in <code>&lt;span&gt;</code>s based on the type of change.</p>
<p>I knew it wouldn’t work everywhere, but it allowed me to refactor the original article and remove all the horrible markup. Plus it was simple, I was done within the hour. I opted to use the existing language tag in Markdown to indicate that it was also a diff, since I couldn’t come up with a cleaner solution (E.g. <code>&lt;language&gt;.diff</code>). But I still wanted a something smarter, something that would work everywhere. This solution had faults when the diff markup messed with the syntax highlighting. So I continued.</p>
<h2>Second Attempt</h2>
<p>The next attempt was more complex. I figured I could match each line type (addition/deletion/metadata/null) and group them together. Then, I would highlight the addition and deletions separately (with null changes filling the spaces). With the two syntax highlighting results, I could go over the code line by line and pick from either the addition or deletion result based on the line type. However, <a href="https://github.com/blakeembrey/blakeembrey.com/blob/1d0a377e9cdea332045bb6f6074fe29848920746/config/markdown.js">this code</a> was brittle. What if a <code>&lt;span&gt;</code> ran over multiple lines?</p>
<h3>Attempt 2.5</h3>
<p>I kept at this solution for a while longer and I added a regex to match open and closing <code>&lt;span&gt;</code>s. Then, I pushed each open <code>&lt;span&gt;</code> onto an array and popped it off with each closing <code>&lt;/span&gt;</code>. If there were any left in each section, I’d close them with a <code>&lt;/span&gt;</code> and open them again in the next section. This was brilliant and clever, I thought, and I needed to publish it. In fact, it wasn’t until I was refactoring this into a module that I realised what a deep grave I was digging myself.</p>
<h2>Final Attempt</h2>
<p>My third and final attempt started where the last one left off. I knew the grouping was the correct approach, but the highlighter needed a better approach. I recalled that I was only using the <code>value</code> property of the returned syntax highlighting object, so I thought it was about time to read some documentation. Lo and behold, I discovered the <a href="http://highlightjs.readthedocs.org/en/latest/api.html#highlight-name-value-ignore-illegals-continuation">third and fourth arguments</a> of Highlight.js.</p>
<p>The third argument was interesting, I could try to ignore illegal characters in the code. I though this might work when the syntax highlighter started in an invalid position. The holy grail, however, was the fourth argument. It would accept a continuation stack, which meant I could probably leave the syntax highlighting incomplete and start it again later. I hoped that this would also close the <code>&lt;/span&gt;</code>s for me, and it did!</p>
<p>I used the previous grouping solution and iterated over each group keeping track of the previously highlighted stack (both addition or deletion). It worked out perfectly and I wrapped each highlighted group in a <code>&lt;span&gt;</code> with its diff type as the class (E.g. <code>&lt;span class=&quot;diff-addition&quot;&gt;</code>). I attempted to use the <code>ignore_illegals</code> argument, but it failed in a JSON example (starting at a property of an object) so I had to disable it again.</p>
<p>The <a href="https://github.com/blakeembrey/highlighter">result of my labour</a> can be viewed below. Diff syntax highlighting in all its glory - the exact same block of code GitHub uses in <a href="https://github.com/blog/1932-syntax-highlighted-diffs">their example</a>!</p>
<pre><code class="language-cs.diff"><span class="diff-chunk">@@ -164,29 +164,34 @@</span>
<span class="diff-null">        [Fact]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddRangeBalanceTest</span>(<span class="hljs-params"></span>)
        </span>{</span>
<span class="diff-addition">            <span class="hljs-keyword">int</span> randSeed = (<span class="hljs-keyword">int</span>)DateTime.Now.Ticks;
            Console.WriteLine(<span class="hljs-string">"Random seed: {0}"</span>, randSeed);
            <span class="hljs-keyword">var</span> random = <span class="hljs-keyword">new</span> Random(randSeed);

            <span class="hljs-keyword">int</span> expectedTotalSize = <span class="hljs-number">0</span>;
</span>
<span class="diff-null">            <span class="hljs-keyword">var</span> list = ImmutableList&lt;<span class="hljs-keyword">int</span>&gt;.Empty;
</span>
<span class="diff-deletion">            <span class="hljs-comment">// Add batches of 32, 128 times, giving 4096 items</span>
            <span class="hljs-keyword">int</span> batchSize = <span class="hljs-number">32</span>;</span>
<span class="diff-addition">            <span class="hljs-comment">// Add some small batches, verifying balance after each</span></span>
<span class="diff-null">            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">128</span>; i++)
            {</span>
<span class="diff-deletion">                list = list.AddRange(Enumerable.Range(batchSize * i + <span class="hljs-number">1</span>, batchSize));
                list.Root.VerifyBalanced();</span>
<span class="diff-addition">                <span class="hljs-keyword">int</span> batchSize = random.Next(<span class="hljs-number">32</span>);
                Console.WriteLine(<span class="hljs-string">"Adding {0} elements to the list"</span>, batchSize);
                list = list.AddRange(Enumerable.Range(expectedTotalSize+<span class="hljs-number">1</span>, batchSize));
                VerifyBalanced(list);
                expectedTotalSize += batchSize;</span>
<span class="diff-null">            }

            <span class="hljs-comment">// Add a single large batch to the end</span></span>
<span class="diff-deletion">            list = list.AddRange(Enumerable.Range(<span class="hljs-number">4097</span>, <span class="hljs-number">61440</span>));
            Assert.Equal(Enumerable.Range(<span class="hljs-number">1</span>, <span class="hljs-number">65536</span>), list);

            list.Root.VerifyBalanced();

            <span class="hljs-comment">// Ensure that tree height is no more than 1 from optimal</span>
            <span class="hljs-keyword">var</span> root = list.Root <span class="hljs-keyword">as</span> IBinaryTree&lt;<span class="hljs-keyword">int</span>&gt;;</span>
<span class="diff-addition">            <span class="hljs-keyword">int</span> largeBatchSize = random.Next(<span class="hljs-number">32768</span>) + <span class="hljs-number">32768</span>;
            Console.WriteLine(<span class="hljs-string">"Adding {0} elements to the list"</span>, largeBatchSize);
            list = list.AddRange(Enumerable.Range(expectedTotalSize + <span class="hljs-number">1</span>, largeBatchSize));
            VerifyBalanced(list);
            expectedTotalSize += largeBatchSize;</span>
<span class="diff-null"></span>
<span class="diff-deletion">            <span class="hljs-keyword">var</span> optimalHeight = Math.Ceiling(Math.Log(root.Count, <span class="hljs-number">2</span>));</span>
<span class="diff-addition">            Assert.Equal(Enumerable.Range(<span class="hljs-number">1</span>, expectedTotalSize), list);</span>
<span class="diff-deletion">            Console.WriteLine(<span class="hljs-string">"Tree depth is {0}, optimal is {1}"</span>, root.Height, optimalHeight);
            Assert.InRange(root.Height, optimalHeight, optimalHeight + <span class="hljs-number">1</span>);</span>
<span class="diff-addition">            list.Root.VerifyHeightIsWithinTolerance();</span>
<span class="diff-null">        }

        [Fact]
</span></code></pre>
<p>The result was extremely satisfying. I coded and refactored over the course of a few days to discover a brilliant solution built directly into the library for me. Is this the final solution, or will there still more to refactor?</p>
</div><hr data-reactid="26"/><p data-reactid="27"><strong data-reactid="28">Questions?</strong><!-- react-text: 29 --> <!-- /react-text --><!-- react-text: 30 -->Ask me on<!-- /react-text --><!-- react-text: 31 --> <!-- /react-text --><a href="https://twitter.com/blakeembrey" data-reactid="32">Twitter</a><!-- react-text: 33 --> <!-- /react-text --><!-- react-text: 34 -->or in<!-- /react-text --><!-- react-text: 35 --> <!-- /react-text --><a href="https://github.com/blakeembrey/knowledge" data-reactid="36">my repo</a><!-- react-text: 37 -->.<!-- /react-text --></p></div></div></div></div></div><script src="/bundle.js?t=1491834725750"></script></body></html>