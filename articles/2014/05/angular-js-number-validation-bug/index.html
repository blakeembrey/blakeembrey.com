<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><title data-react-helmet="true">Avoid type=&quot;number&quot; in AngularJS • Blake Embrey</title><meta data-react-helmet="true" name="description" content="A personally curated collection of words hosted in cyberspace for an indeterminate duration."/><style data-react-free-style="true">::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-cancel-button,[type="search"]::-webkit-search-decoration{-webkit-appearance:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}audio:not([controls]){display:none;height:0}b,strong{font-weight:inherit;font-weight:bolder}button,html [type="button"], [type="reset"],[type="submit"]{-webkit-appearance:button}button,input{overflow:visible}button,input,optgroup,select,textarea{margin:0}button,select{text-transform:none}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}audio,video,canvas{display:inline-block}dfn{font-style:italic}article,aside,footer,header,nav,section,details,menu,figcaption,figure,main{display:block}figure{margin:1em 40px}h1{font-size:2em;margin:0.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.15}img{border-style:none}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}mark{background-color:#ff0;color:#000}code,kbd,samp,pre{font-family:monospace, monospace;font-size:1em}progress{display:inline-block;vertical-align:baseline}small{font-size:80%}sub{bottom:-0.25em}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}summary{display:list-item}sup{top:-0.5em}svg:not(:root){overflow:hidden}[hidden],template{display:none}textarea{overflow:auto}*{box-sizing:border-box}.hljs-addition{background:#dfd}.hljs-attribute,.hljs-variable,.hljs-body{color:#008080}.hljs-change{background:#0086b3}.hljs-class .hljs-title,.hljs-type,.hljs-literal,.hljs-command{color:#458;font-weight:500}.hljs-deletion{background:#fdd}.hljs-header,.hljs-comment,.hljs-javadoc{color:#969896}.hljs-keyword,.hljs-winutils,.hljs-subst,.hljs-request,.hljs-status{color:#a71d5d}.hljs-built_in,.hljs-number,.hljs-hexcolor,.hljs-constant{color:#0086b3}.hljs-preprocessor,.hljs-pragma,.hljs-pi,.hljs-doctype,.hljs-shebang,.hljs-cdata{color:#999;font-weight:500}.hljs-regexp{color:#009926}.hljs-string,.hljs-tag .hljs-value,.hljs-phpdoc,.hljs-dartdoc,.hljs-formula{color:#df5000}.hljs-symbol,.hljs-symbol .hljs-string,.hljs-special,.hljs-prompt{color:#990073}.hljs-tag,.hljs-tag .hljs-title,.hljs-rules .hljs-property{color:#000080}.hljs-title,.hljs-id,.hljs-preprocessor{color:#795da3}a{border-bottom:2px solid #dcdcdc;color:#111;text-decoration:none}a:hover{border-bottom-color:#f20}body{color:#111;font-family:sans-serif;font-size:17px;font-weight:300;line-height:1.7;margin:0}pre .diff-addition{background-color:#dfd}.hljs-chunk,pre .diff-chunk{color:#aaa}pre .diff-deletion{background-color:#fdd}.f1evzss3{border-top:4px solid #f20}.fsclf6o{margin:0 auto;max-width:640px;padding:20px}.f5tm013{margin:0;padding:30px 0}.f5tm013 > li{display:inline-block;list-style:none;margin-right:20px}.f5qoj4b{border-bottom-color:transparent;color:#333}.f13o7dmr h1, h2, h3, h4, h5, h6{font-weight:500}.f13o7dmr h1{font-size:1.7em}.f13o7dmr h2{font-size:1.3em}.f13o7dmr h3{font-size:1.1em}.f13o7dmr hr{border-bottom:1px dashed #fff;border-top:1px dashed #aaa;display:block;margin:1.5em 0}.f13o7dmr blockquote{border-left:4px solid #f20;margin:1em 0;padding-left:1em}.f13o7dmr img,audio,embed,video,object{height:auto;max-width:100%}.f13o7dmr code, pre{background-color:#f3f3f3;border:1px solid #ccc;color:#111;font-family:monospace;font-size:0.9em}.f13o7dmr pre{line-height:1.3;overflow-x:auto;padding:0.6em 0.8em}.f13o7dmr code{border-color:#ccc;display:inline;padding:0 0.3em;white-space:pre-line;word-wrap:break-word}.f13o7dmr pre > code{background-color:transparent;border:none;font-size:100%;padding:0;white-space:pre;word-wrap:normal}.f13o7dmr a:hover > code{border-color:#f20}.f1ymzfbz{color:#777;font-size:0.85em;margin:1.5em 0;padding:0}.f1ymzfbz > li > a{color:#777}.f1ymzfbz > li{display:inline-block;list-style:none;padding-right:20px}</style></head><body><div id="react-mount"><div data-reactroot="" data-reactid="1" data-react-checksum="-408190172"><!-- react-empty: 2 --><div class="f1evzss3" data-reactid="3"></div><div class="fsclf6o" data-reactid="4"><ul class="f5tm013" data-reactid="5"><li data-reactid="6"><a class="f5qoj4b" href="/" data-reactid="7">Blog</a></li><li data-reactid="8"><a class="f5qoj4b" href="http://blakeembrey.me" data-reactid="9">About</a></li><li data-reactid="10"><a class="f5qoj4b" href="/rss.xml" data-reactid="11">RSS</a></li></ul><div class="f13o7dmr" data-reactid="12"><div data-reactid="13"><!-- react-empty: 14 --><h1 data-reactid="15">Avoid type=&quot;number&quot; in AngularJS</h1><ul class="f1ymzfbz" data-reactid="16"><li data-reactid="17"><!-- react-text: 18 -->Written<!-- /react-text --><!-- react-text: 19 --> <!-- /react-text --><time datetime="2014-05-10T03:00:00.000Z" data-reactid="20">May 2014</time></li></ul><div data-reactid="21"><p>The other day I got hit by a peculiar bug in Angular. Using <code>type=&quot;number&quot;</code> on an input element wouldn’t do any number validation. On top of this, when I entered an invalid number the only validation failing was <code>required</code>.</p>
<p>After a little research, it turned out to be a <a href="http://www.w3.org/TR/html5/forms.html#number-state-%28type=number%29">“feature”</a> of blocking access to the <code>value</code> attribute when it’s an invalid number. Not all browsers follow the complete spec, so I found this was working in Firefox. Back in Chrome however, it was failing. You can even test this in the <a href="https://docs.angularjs.org/api/ng/input/input%5Bnumber%5D">AngularJS documentation</a> by typing an invalid number in the demo and looking at the error message.</p>
<h2>Custom Type Directive</h2>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> app = angular.module(<span class="hljs-string">'myApp'</span>, []);

<span class="hljs-comment">/**
 * Provide custom type validation for input elements. Certain type attributes
 * don't work consistenty cross-browser, so this is a required workaround.
 * Looking at you, webkit and `type="number"`.
 *
 * ```html
 * &lt;input
 *   ng-model=""
 *   app-type=""&gt;
 * ```
 */</span>
app.directive(<span class="hljs-string">'appType'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">require</span>: <span class="hljs-string">'ngModel'</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, elem, attrs, ctrl</span>) </span>{
      <span class="hljs-comment">// Custom number validation logic.</span>
      <span class="hljs-keyword">if</span> (attrs.appType === <span class="hljs-string">'number'</span>) {
        <span class="hljs-keyword">return</span> ctrl.$parsers.push(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
          <span class="hljs-keyword">var</span> valid = value == <span class="hljs-literal">null</span> || <span class="hljs-built_in">isFinite</span>(value);

          ctrl.$setValidity(<span class="hljs-string">'number'</span>, valid);

          <span class="hljs-keyword">return</span> valid &amp;&amp; value != <span class="hljs-literal">null</span> ? <span class="hljs-built_in">Number</span>(value) : <span class="hljs-literal">undefined</span>;
        });
      }
    }
  };
});
</code></pre>
<p>The code above adds a new custom directive that requires <code>ngModel</code>. Requiring <code>ngModel</code> provides us with the <a href="http://docs.angularjs.org/api/ng.directive:ngModel.NgModelController">ngModelController</a>. Using the controller we can access some useful methods, including model input parsing and validity - which makes up the bulk of our validation logic.</p>
<p>When the type is <code>number</code>, we push a custom parser onto the stack. Our parser goes on the end and will run after any other parsers, allowing us to keep the <code>required</code> directive in tact. The validity itself checks if the value is empty (<code>null</code> or <code>undefined</code>) or that it’s a valid JavaScript number. Valid “JavaScript number” is important to note, since this will allow the most comprehensive check including integers, floats, negative and positive notation, but also other notations such as <code>0x1e5</code> and <code>1e5</code>.</p>
<p>Validity gets set next and based on the result we’ll coerce the value into a number. By doing number coercion, the model will correctly receive the number instead of the string representation. We want to avoid coercing empty values (<code>null</code> and <code>undefined</code>) however, which will come out as <code>0</code> and <code>NaN</code> respectfully.</p>
<h2>Recreating min and max directives</h2>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> app = angular.module(<span class="hljs-string">'myApp'</span>, []);

<span class="hljs-comment">/**
 * Provide minimum number validation for any input.
 *
 * ```html
 * &lt;input
 *   ng-model=""
 *   app-min=""&gt;
 * ```
 */</span>
app.directive(<span class="hljs-string">'appMin'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">require</span>: <span class="hljs-string">'ngModel'</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, elem, attrs, ctrl</span>) </span>{
      <span class="hljs-keyword">return</span> ctrl.$parsers.push(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
        <span class="hljs-keyword">var</span> valid = value == <span class="hljs-literal">null</span> || <span class="hljs-built_in">Number</span>(value) &gt;= <span class="hljs-built_in">Number</span>(attrs.appMin);

        ctrl.$setValidity(<span class="hljs-string">'min'</span>, valid);

        <span class="hljs-keyword">return</span> valid ? value : <span class="hljs-literal">undefined</span>;
      });
    }
  };
});
</code></pre>
<p>Recreating the <code>min</code> directive is trivial and we can easily make it work for any input. The above validation does the <code>null</code> check again, which will make an empty input element valid. This is important since we don’t want to provide unnecessary validation and bundle the <code>required</code> directives job into ours.</p>
<p>Next it’s just a process of coercing both the value and attribute into numbers and comparing the values. If either are <code>NaN</code>, validation will fail. This provides some form of ensuring we have numbers only, but won’t do any number coerce to the model. Finally, we return either the value or <code>undefined</code> if validation failed.</p>
<h2>Unit Testing</h2>
<p>Unit testing the functionality was straightforward enough, so I won’t provide all the code used. A couple of things worth mentioning though is how to compile the templates for testing and set the values for validation.</p>
<pre><code class="language-javascript">it(<span class="hljs-string">'...'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  inject(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$compile, $rootScope</span>) </span>{
    <span class="hljs-keyword">var</span> $scope = $rootScope.$<span class="hljs-keyword">new</span>();

    $scope.model = {};

    <span class="hljs-keyword">var</span> $element = $compile(
      <span class="hljs-string">'&lt;form name="form"&gt;'</span> +
      <span class="hljs-string">'  &lt;input name="num" ng-model="model.value" app-type="number"&gt;'</span> +
      <span class="hljs-string">'&lt;/form&gt;'</span>
    )($scope);

    <span class="hljs-comment">// Set the value to what you want to test.</span>
    $scope.form.num.$setViewValue(<span class="hljs-string">'10'</span>);

    <span class="hljs-comment">// Check the model is what you expect and check validation.</span>
    $scope.model.value.should.equal(<span class="hljs-number">10</span>);
    $scope.form.num.$invalid.should.be.false;
  });
});
</code></pre>
</div><hr data-reactid="22"/><p data-reactid="23"><strong data-reactid="24">Questions?</strong><!-- react-text: 25 --> <!-- /react-text --><!-- react-text: 26 -->Ask me on<!-- /react-text --><!-- react-text: 27 --> <!-- /react-text --><a href="https://twitter.com/blakeembrey" data-reactid="28">Twitter</a><!-- react-text: 29 --> <!-- /react-text --><!-- react-text: 30 -->or in<!-- /react-text --><!-- react-text: 31 --> <!-- /react-text --><a href="https://github.com/blakeembrey/knowledge" data-reactid="32">my repo</a><!-- react-text: 33 -->.<!-- /react-text --></p></div></div></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', "UA-22855713-2", 'auto');
          ga('send', 'pageview');</script><script src="/bundle.js?t=1492474075045"></script></body></html>