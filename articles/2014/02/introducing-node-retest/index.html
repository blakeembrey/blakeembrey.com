<!DOCTYPE html>
 <html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><title data-react-helmet="true">Introducing Retest • Blake Embrey</title><meta data-react-helmet="true" name="description" content="A personally curated collection of words hosted in cyberspace for an indeterminate duration."/><meta data-react-helmet="true" name="og:type" content="article"/><meta data-react-helmet="true" name="og:title" content="Introducing Retest"/><meta data-react-helmet="true" name="og:site_name" content="Blake Embrey"/><meta data-react-helmet="true" name="og:url" content="http://blakeembrey.com/articles/2014/02/introducing-node-retest/"/><meta data-react-helmet="true" name="article:published_time" content="2014-02-12T07:30:00.000Z"/><meta data-react-helmet="true" name="twitter:site" content="@blakeembrey"/><style data-react-free-style="true">::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-cancel-button,[type="search"]::-webkit-search-decoration{-webkit-appearance:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}audio:not([controls]){display:none;height:0}b,strong{font-weight:inherit;font-weight:bolder}button,html [type="button"], [type="reset"],[type="submit"]{-webkit-appearance:button}button,input{overflow:visible}button,input,optgroup,select,textarea{margin:0}button,select{text-transform:none}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}audio,video,canvas{display:inline-block}dfn{font-style:italic}article,aside,footer,header,nav,section,details,menu,figcaption,figure,main{display:block}figure{margin:1em 40px}h1{font-size:2em;margin:0.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.15}img{border-style:none}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}mark{background-color:#ff0;color:#000}code,kbd,samp,pre{font-family:monospace, monospace;font-size:1em}progress{display:inline-block;vertical-align:baseline}small{font-size:80%}sub{bottom:-0.25em}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}summary{display:list-item}sup{top:-0.5em}svg:not(:root){overflow:hidden}[hidden],template{display:none}textarea{overflow:auto}*{box-sizing:border-box}.hljs-addition{background:#dfd}.hljs-attribute,.hljs-variable,.hljs-body{color:#008080}.hljs-change{background:#0086b3}.hljs-class .hljs-title,.hljs-type,.hljs-literal,.hljs-command{color:#458;font-weight:500}.hljs-deletion{background:#fdd}.hljs-header,.hljs-comment,.hljs-javadoc{color:#969896}.hljs-keyword,.hljs-winutils,.hljs-subst,.hljs-request,.hljs-status{color:#a71d5d}.hljs-built_in,.hljs-number,.hljs-hexcolor,.hljs-constant{color:#0086b3}.hljs-preprocessor,.hljs-pragma,.hljs-pi,.hljs-doctype,.hljs-shebang,.hljs-cdata{color:#999;font-weight:500}.hljs-regexp{color:#009926}.hljs-string,.hljs-tag .hljs-value,.hljs-phpdoc,.hljs-dartdoc,.hljs-formula{color:#df5000}.hljs-symbol,.hljs-symbol .hljs-string,.hljs-special,.hljs-prompt{color:#990073}.hljs-tag,.hljs-tag .hljs-title,.hljs-rules .hljs-property{color:#000080}.hljs-title,.hljs-id,.hljs-preprocessor{color:#795da3}a{border-bottom:2px solid #dcdcdc;color:#111;text-decoration:none}a:hover{border-bottom-color:#f20}body{color:#111;font-family:sans-serif;font-size:17px;font-weight:300;line-height:1.7;margin:0}pre .diff-addition{background-color:#dfd}.hljs-chunk,pre .diff-chunk{color:#aaa}pre .diff-deletion{background-color:#fdd}.f1evzss3{border-top:4px solid #f20}.fsclf6o{margin:0 auto;max-width:640px;padding:20px}.f5tm013{margin:0;padding:30px 0}.f5tm013 > li{display:inline-block;list-style:none;margin-right:20px}.f5qoj4b{border-bottom-color:transparent;color:#333}.f13o7dmr h1, h2, h3, h4, h5, h6{font-weight:500}.f13o7dmr h1{font-size:1.7em}.f13o7dmr h2{font-size:1.3em}.f13o7dmr h3{font-size:1.1em}.f13o7dmr hr{border-bottom:1px dashed #fff;border-top:1px dashed #aaa;display:block;margin:1.5em 0}.f13o7dmr blockquote{border-left:4px solid #f20;margin:1em 0;padding-left:1em}.f13o7dmr img,audio,embed,video,object{height:auto;max-width:100%}.f13o7dmr code, pre{background-color:#f3f3f3;border:1px solid #ccc;color:#111;font-family:monospace;font-size:0.9em}.f13o7dmr pre{line-height:1.3;overflow-x:auto;padding:0.6em 0.8em}.f13o7dmr code{border-color:#ccc;display:inline;padding:0 0.3em;white-space:pre-line;word-wrap:break-word}.f13o7dmr pre > code{background-color:transparent;border:none;font-size:100%;padding:0;white-space:pre;word-wrap:normal}.f13o7dmr a:hover > code{border-color:#f20}.f1ymzfbz{color:#777;font-size:0.85em;margin:1.5em 0;padding:0}.f1ymzfbz > li > a{color:#777}.f1ymzfbz > li{display:inline-block;list-style:none;padding-right:20px}</style></head><body><div id="react-mount"><div data-reactroot="" data-reactid="1" data-react-checksum="-11338886"><!-- react-empty: 2 --><div class="f1evzss3" data-reactid="3"></div><div class="fsclf6o" data-reactid="4"><ul class="f5tm013" data-reactid="5"><li data-reactid="6"><a class="f5qoj4b" href="/" data-reactid="7">Blog</a></li><li data-reactid="8"><a class="f5qoj4b" href="http://blakeembrey.me" data-reactid="9">About</a></li><li data-reactid="10"><a class="f5qoj4b" href="/rss.xml" data-reactid="11">RSS</a></li></ul><div class="f13o7dmr" data-reactid="12"><div data-reactid="13"><!-- react-empty: 14 --><h1 data-reactid="15">Introducing Retest</h1><ul class="f1ymzfbz" data-reactid="16"><li data-reactid="17"><!-- react-text: 18 -->Written<!-- /react-text --><!-- react-text: 19 --> <!-- /react-text --><time datetime="2014-02-12T07:30:00.000Z" data-reactid="20">February 2014</time></li></ul><div data-reactid="21"><p>If you’ve looked into testing your API in node before, you’ve probably run across <a href="https://github.com/visionmedia/supertest">supertest</a> by the prolific TJ Holowaychuk. So have I and it’s truly a fantastic library for testing APIs. However, I found it to be lacking a couple of features I sorely needed. And to my surprise, I struggled to find another request testing module in the node ecosystem.</p>
<p>The reason I wrote <a href="https://github.com/blakeembrey/retest">retest</a> is actually fairly simple. I needed to do away with the verbose chaining syntax and I had no need for the assertions built into supertest. Although I also could have written a HTTP request layer for retest, I decided to go with <a href="https://github.com/mikeal/request">request</a>. It’s an extremely useful and well tested library for making requests, with numerous features already built-in that make it perfect for tests.</p>
<h2>How Do I Use It?</h2>
<p>I based the implementation on combining the usefulness of supertest with the conciseness of request, so it’s extremely straightforward to get started. First we create a test request instance by wrapping an express application.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> retest  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'retest'</span>);
<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> app     = express();

<span class="hljs-comment">// Creates a request instance for interacting with our application. If the</span>
<span class="hljs-comment">// application is not already listening on a port number, it will be bound to</span>
<span class="hljs-comment">// an ephemeral port.</span>
<span class="hljs-keyword">var</span> request = retest(app);
</code></pre>
<p>The <code>request</code> variable is now a wrapped instance of request, made to make requests relative to your app. You can even pass other objects to create your <code>request</code> instance.</p>
<pre><code class="language-javascript"><span class="hljs-comment">// Create a request instance for a remote server.</span>
<span class="hljs-keyword">var</span> request = retest(<span class="hljs-string">'http://google.com'</span>);

<span class="hljs-comment">// Listen to a normal http(s) server.</span>
<span class="hljs-keyword">var</span> server  = https.createServer({ ... }, app);
<span class="hljs-keyword">var</span> request = retest(server);
</code></pre>
<p>Now that we have our request instance, we can make requests using the options supported by <a href="https://github.com/mikeal/request#requestoptions-callback">request</a>. That’s a load of functionality built-in, so I’ll give you a chance to peruse it later. For a basic demo, we’ll make a request to the root of our server.</p>
<pre><code class="language-javascript">request(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, res</span>) </span>{
  <span class="hljs-comment">// We have access to the response body here. Or an error if something broke.</span>
});
</code></pre>
<p>That was simple. We just made the first request to our API. Now we can look at turning this into a test. I’m using Mocha and Chai, but it should make sense if you’ve never used them.</p>
<pre><code class="language-javascript">it(<span class="hljs-string">'should respond with "success"'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
  request(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, res</span>) </span>{
    expect(res.statusCode).to.equal(<span class="hljs-number">200</span>);
    expect(res.body).to.equal(<span class="hljs-string">'success'</span>);
    done(err);
  });
});
</code></pre>
<h2>What Else Does Retest Do?</h2>
<p>Retest is a fairly thin wrapper around request, since so much functionality already exists in the core module. You can already pipe data to and from your requests, authenticate using OAuth or send custom query strings, bodies and headers. However, one useful feature of retest is automatic request and response body parsing.</p>
<p>If your request specifies a JSON or URL-encoded content type and has a body, it will be automatically serialized.</p>
<pre><code class="language-javascript">app.post(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
  res.send(req.body);
});

retest(app).post(<span class="hljs-string">'/'</span>, {
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
  },
  <span class="hljs-attr">body</span>: {
    <span class="hljs-attr">test</span>: <span class="hljs-string">'data'</span>
  }
}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, res</span>) </span>{
  <span class="hljs-comment">// The response would be the JSON-encoded data. If the request `Content-Type`</span>
  <span class="hljs-comment">// was set to `application/x-www-form-urlencoded`, we would expect the</span>
  <span class="hljs-comment">// response body to equal `test=data`.</span>
  expect(res.body).to.equal(<span class="hljs-string">'{"test":"data"}'</span>);
});
</code></pre>
<p>Even the response body can be parsed. If the response <code>Content-Type</code> is set to either JSON or URL-encoding, it will be parsed and set as <code>res.body</code>.</p>
<p>Another feature borrowed from supertest is <code>retest.agent</code>. Using the agent function returns an instance of request that is using a single cookie jar. This lets cookies persist between API requests.</p>
<h2>Why Remove Chaining and Assertions?</h2>
<p>The reason behind removing the chaining syntax is a result of my recent work with generator functions. Once I started writing my code using generators, I found it disconnecting to writing my tests using callbacks. So I implemented <a href="https://github.com/blakeembrey/co-retest">co-retest</a> which returns thunks. Combine this with <a href="https://github.com/blakeembrey/co-mocha">co-mocha</a> and now we can write a really elegant API test suite.</p>
<pre><code class="language-javascript">it(<span class="hljs-string">'should respond with "success"'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>* (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> res = <span class="hljs-keyword">yield</span> request(<span class="hljs-string">'/'</span>);

  expect(res.statusCode).to.equal(<span class="hljs-number">200</span>);
  expect(res.body).to.equal(<span class="hljs-string">'success'</span>);
});
</code></pre>
<p>It’s important to note that generators are only available in node 0.11 and needs to be enabled using the <code>--harmony-generators</code> flag.</p>
</div><hr data-reactid="22"/><p data-reactid="23"><strong data-reactid="24">Questions?</strong><!-- react-text: 25 --> <!-- /react-text --><!-- react-text: 26 -->Ask me on<!-- /react-text --><!-- react-text: 27 --> <!-- /react-text --><a href="https://twitter.com/blakeembrey" data-reactid="28">Twitter</a><!-- react-text: 29 --> <!-- /react-text --><!-- react-text: 30 -->or in<!-- /react-text --><!-- react-text: 31 --> <!-- /react-text --><a href="https://github.com/blakeembrey/knowledge" data-reactid="32">my repo</a><!-- react-text: 33 -->.<!-- /react-text --></p></div></div></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', "UA-22855713-2", 'auto');
          ga('send', 'pageview');</script><script src="/bundle.js?t=1492907098323"></script></body></html>